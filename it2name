#!/usr/bin/env bash
set -e

VERSION="0.1.0"

# Defaults
FG="white"
BG="black"
TEXT=""

show_version() {
  echo "it2name version $VERSION"
  exit 0
}

show_help() {
  cat <<EOF
it2name - iTerm2 caption renderer and tab name setter

Usage: it2name [OPTIONS] TEXT

Arguments:
  TEXT                    Text to render (use "." for current directory name)

Options:
  --fgcolor COLOR        Set foreground/text color (default: white)
  --bgcolor COLOR        Set background color (default: black)
  --version              Show version information
  --help                 Show this help message

Examples:
  it2name "Hello World"
  it2name .
  it2name --fgcolor red --bgcolor black "Production"

Colors: Any ImageMagick-supported color name (red, blue, green, yellow, etc.)
EOF
  exit 0
}

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --version)
      show_version
      ;;
    --help|-h)
      show_help
      ;;
    --fgcolor)
      FG="$2"
      shift 2
      ;;
    --bgcolor)
      BG="$2"
      shift 2
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      TEXT="$1"
      shift
      ;;
  esac
done

if [[ -z "$TEXT" ]]; then
  echo "Error: TEXT argument is required" >&2
  echo "Usage: it2name [--fgcolor COLOR] [--bgcolor COLOR] TEXT" >&2
  echo "Try 'it2name --help' for more information." >&2
  exit 1
fi

# If the TEXT is just . then we want just show the folder name
if [[ "$TEXT" == "." ]]; then
  TEXT="$(basename "$PWD")"
fi

# Detect terminal size using stty (most reliable in subshells)
if read ROWS COLS < <(stty size </dev/tty 2>/dev/null); then
  : # success
else
  COLS=${COLUMNS:-120}
  ROWS=${LINES:-40}
fi

# Calculate image dimensions based on terminal size
# chafa uses ~2 rows per character height, and ~1 col per character width
IMG_W=$((COLS * 10))
IMG_H=$((ROWS * 20))

magick \
  -background "$BG" \
  -fill "$FG" \
  -font Helvetica-Bold \
  -gravity center \
  -size "${IMG_W}x${IMG_H}" \
  caption:"$TEXT" \
  png:- \
| chafa --symbols block --colors full --size "${COLS}x${ROWS}"

# Set iTerm2 session/tab name
printf '\e]1;%s\a' "$TEXT"
# echo out the pwd to stdout
pwd

